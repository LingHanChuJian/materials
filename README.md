# 二维排料系统

基于遗传算法（GA）+ NFP（No-Fit Polygon）+ Skyline 的智能排料系统。

## 系统架构

```
GA (遗传算法) → genome (顺序+角度)
       │
       ▼
  Fitness 计算
       │
       ├─ NFP: 计算零件禁区/可放置位置
       └─ Skyline: 放置零件、更新天际线
       │
       ▼
   总长度 → fitness
       │
       ▼
GA: 选择/交叉/变异
       │
       ▼
下一代 genome
```

## 核心模块

### 1. GA (遗传算法) - `core/ga.py`
- **种群管理**：维护多个排料方案
- **适应度计算**：评估每个方案的材料利用率
- **遗传操作**：
  - 锦标赛选择
  - OX 交叉（保留顺序）
  - 变异（顺序交换 + 角度变异）
- **精英保留**：保留最优解

### 2. Packer (排料器) - `core/packer.py`
- **放置策略**：Bottom-Left 策略
- **碰撞检测**：基于 Shapely 的几何检测
- **候选位置生成**：基于已放置零件边界生成候选点

### 3. NFP (禁区多边形) - `core/nfp.py`
- **计算禁区**：计算两个零件的 No-Fit Polygon
- **碰撞检测**：判断位置是否合法
- **间距处理**：支持零件间最小间距

### 4. GraphicsProcessing (图形预处理) - `utils/graphics_processing.py`
- **轮廓提取**：从图像提取零件轮廓
- **多边形简化**：减少顶点数量
- **角度缓存**：预计算不同角度的旋转结果

## 使用方法

### 1. 准备零件图像
将零件的二值图像（PNG 格式）放入 `assets` 文件夹。

### 2. 配置参数
编辑 `settings/settings.py`：

```python
class Settings:
    width: float = 1560.0        # 排料板宽度（mm）
    length: float = 10000.0      # 排料板长度（mm）
    spacing: float = 1.0         # 零件间距（mm）
    angles: list[float] = [0.0, 180.0]  # 允许的旋转角度
```

### 3. 运行排料
```bash
uv run python main.py
```

### 4. 查看结果
- 可视化结果保存在 `test` 文件夹
- 命名格式：`generation_XXXX.png`
- 显示信息：
  - 当前代数
  - 总长度
  - 材料利用率
  - 每个零件的位置和角度

## 输出示例

```
============================================================
排料完成！
============================================================

最优排料结果:
  总长度: 1087.91mm
  零件数: 10
  材料利用率: 80.57%

零件放置详情:
  零件 9: 位置=(0.00, 0.00)mm, 角度=180.0°
  零件 7: 位置=(0.00, 582.13)mm, 角度=0.0°
  零件 6: 位置=(589.23, 583.13)mm, 角度=0.0°
  ...

所有迭代结果已保存到 test 文件夹
============================================================
```

## 参数调优

### GA 参数（在 main.py 中）
```python
pop_size = 40           # 种群大小（越大越好，但更慢）
generations = 100       # 迭代次数
visualize_interval = 5  # 可视化间隔
```

### 性能优化
1. **减少角度选项**：`angles = [0.0]` 比 `[0, 90, 180, 270]` 快 4 倍
2. **增加简化容差**：`tolerance = 1.0` 比 `0.1` 快，但精度降低
3. **减少零件数**：计算复杂度随零件数指数增长

## 算法特点

### 优势
✅ 无重叠：严格的碰撞检测确保零件不重叠  
✅ 自适应：自动优化零件顺序和旋转角度  
✅ 可视化：每次迭代输出图像，便于分析  
✅ 可扩展：支持任意形状的多边形零件  

### 局限
⚠️ 计算密集：大规模问题（50+ 零件）计算时间较长  
⚠️ 局部最优：遗传算法可能陷入局部最优解  
⚠️ 参数敏感：需要根据实际问题调整参数  

## 依赖项

```toml
[project]
dependencies = [
    "matplotlib>=3.10.8",   # 可视化
    "numpy>=2.3.5",         # 数值计算
    "opencv-python>=4.11.0", # 图像处理
    "shapely>=2.1.2",       # 几何计算
    "pyclipper>=1.4.0",     # 多边形运算
]
```

## 技术细节

### 适应度函数
```python
fitness = -total_length  # 负值，越小越好（GA 求最大值）
```

### 放置策略
1. 生成候选位置（基于已放置零件边界）
2. 按 Bottom-Left 顺序排序（优先 Y 小，其次 X 小）
3. 检查每个候选位置是否合法（无碰撞）
4. 选择得分最小的合法位置

### 碰撞检测
```python
if test_poly.intersects(placed_poly):
    return True  # 碰撞
if test_poly.distance(placed_poly) < spacing:
    return True  # 间距不足
```

## 进一步改进方向

1. **集成 NFP**：完全使用 NFP 进行精确碰撞检测
2. **Skyline 优化**：使用真正的 Skyline 算法管理天际线
3. **局部搜索**：在 GA 基础上添加局部优化
4. **多目标优化**：同时优化长度和利用率
5. **并行计算**：利用多核 CPU 加速适应度计算

## 许可证

MIT License

